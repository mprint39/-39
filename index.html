<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Калькулятор MPrint_39</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Подключение библиотеки SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* Стили оставлены без изменений */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background-color: var(--tg-theme-bg-color, #f5f5f5); color: var(--tg-theme-text-color, #222222); min-height: 100vh; }
        .container { max-width: 100%; margin: 0 auto; padding: 12px; }
        header { text-align: center; padding: 16px 12px; background: linear-gradient(135deg, #2c3e50, #4a6491); color: white; border-radius: 12px; margin-bottom: 16px; }
        h1 { font-size: 20px; margin-bottom: 4px; }
        .subtitle { font-size: 14px; opacity: 0.9; }
        .tabs { display: flex; background-color: var(--tg-theme-secondary-bg-color, #e9ecef); border-radius: 12px; padding: 4px; margin-bottom: 16px; }
        .tab-btn { flex: 1; padding: 10px; background: none; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; color: var(--tg-theme-text-color, #495057); cursor: pointer; transition: all 0.2s ease; }
        .tab-btn.active { background-color: var(--tg-theme-button-color, #3366cc); color: #fff; }
        .tab-content { display: none; padding-bottom: 20px; }
        .tab-content.active { display: block; }
        .section-title { font-size: 16px; font-weight: 600; margin: 16px 0 10px; }
        .button-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px; }
        .option-button { padding: 12px 8px; background-color: var(--tg-theme-secondary-bg-color, #e9ecef); border: 2px solid transparent; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; text-align: center; }
        .option-button.selected { background-color: var(--tg-theme-button-color, #3366cc); color: #fff; border-color: var(--tg-theme-button-color, #3366cc); }
        .quantity-input, .dimension-input { width: 100%; padding: 14px; border: 2px solid #ced4da; border-radius: 10px; font-size: 16px; text-align: center; }
        .btn { display: block; width: 100%; padding: 16px; background: linear-gradient(135deg, var(--tg-theme-button-color, #3366cc), #254eab); color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin: 20px 0; }
        .btn-telegram { background: linear-gradient(135deg, #2AABEE, #229ED9); }
        .cart { margin-top: 20px; border: 1px solid #dee2e6; border-radius: 12px; padding: 16px; background-color: #fff; }
        .cart-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; text-align: center; }
        .total-price { font-size: 22px; font-weight: bold; color: #3366cc; margin: 8px 0; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Калькулятор MPrint_39</h1>
        <p class="subtitle">Расчет стоимости печати</p>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('calculator')">Расчет</button>
        <button class="tab-btn" onclick="showTab('stickers')">Наклейки</button>
        <button class="tab-btn" onclick="showTab('contacts')">Контакты</button>
    </div>

    <!-- Вкладка Калькулятор -->
    <div id="calculator" class="tab-content active">
        <div class="section-title">Тип продукции:</div>
        <div class="button-grid" id="section-buttons"></div>

        <div class="section-title">Формат:</div>
        <div class="button-grid" id="format-buttons"></div>

        <div class="section-title">Цветность:</div>
        <div class="button-grid" id="color-buttons"></div>

        <div class="section-title">Плотность:</div>
        <div class="button-grid" id="density-buttons"></div>

        <div class="section-title">Материал:</div>
        <div class="button-grid" id="material-buttons"></div>

        <div class="input-group">
            <label class="input-label" for="quantity">Количество:</label>
            <input type="number" id="quantity" class="quantity-input" value="1" min="1" onchange="updatePriceInfo()">
        </div>

        <div id="price-info" class="price-info hidden">
            <strong>Информация о цене:</strong>
            <div id="price-details" class="price-details"></div>
        </div>

        <button class="btn" onclick="addToCart()">Добавить в заказ</button>

        <div class="cart">
            <div class="cart-title">Корзина заказов</div>
            <div id="cart-items"></div>
            <div class="total">
                <div>Итоговая стоимость:</div>
                <div id="total-price" class="total-price">0 руб.</div>
                <button class="btn btn-telegram" onclick="openTelegram()">Написать для заказа</button>
            </div>
        </div>
    </div>

    <!-- Вкладка Расчет наклеек -->
    <div id="stickers" class="tab-content">
        <div class="section-title">Тип листа:</div>
        <div class="button-grid">
            <button class="option-button selected" onclick="selectStickerOption('sheet-type', 'SRA3', this)">SRA3 (285×385 мм)</button>
            <button class="option-button" onclick="selectStickerOption('sheet-type', 'SRA4', this)">SRA4 (210×285 мм)</button>
        </div>

        <div class="section-title">Тип изделия:</div>
        <div class="button-grid">
            <button class="option-button selected" onclick="selectStickerOption('item-type', 'rect', this); toggleStickerFields()">Прямоугольник/Квадрат</button>
            <button class="option-button" onclick="selectStickerOption('item-type', 'circle', this); toggleStickerFields()">Круг</button>
        </div>

        <div id="rect-fields">
            <div class="input-group">
                <label class="input-label" for="length">Длина (мм):</label>
                <input type="number" id="length" class="dimension-input" step="0.1">
            </div>
            <div class="input-group">
                <label class="input-label" for="width">Ширина (мм):</label>
                <input type="number" id="width" class="dimension-input" step="0.1">
            </div>
        </div>

        <div id="circle-fields" class="hidden">
            <div class="input-group">
                <label class="input-label" for="diameter">Диаметр (мм):</label>
                <input type="number" id="diameter" class="dimension-input" step="0.1">
            </div>
        </div>

        <button class="btn" onclick="calculateStickers()">Рассчитать</button>

        <div class="sticker-result">
            <div>Количество изделий на листе:</div>
            <div id="total-items" class="sticker-count">0</div>
        </div>
    </div>

    <!-- Вкладка Контакты -->
    <div id="contacts" class="tab-content">
        <div class="section-title">Контакты типографии</div>
        <div class="contacts-grid">
            <p>Типография: MPrint_39</p>
            <p>Адрес: Горького 55, ТЦ Две Пятёрки, 2 этаж, пав. 226</p>
            <p>Телефон: 8 (909) 788-88-52</p>
            <p>Telegram: <a href="https://t.me/Mobik39_print" target="_blank">@Mobik39_print</a></p>
            <p>Организация: ИП Кот Алексей Игоревич</p>
            <p>ИНН: 392403164120</p>
            <p>ОГРН: 323390000002616</p>
        </div>
    </div>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    let priceData = {};
    let cart = [];
    let currentSection = '', currentFormat = '', currentColor = '', currentDensity = '', currentMaterial = '';
    let currentSheetType = 'SRA3';
    let currentItemType = 'rect';

    async function loadPriceData() {
        const response = await fetch('data.xlsx');
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });

        workbook.SheetNames.forEach(sheetName => {
            const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
            priceData[sheetName] = sheet.map(row => ({
                format: row["Формат"],
                color: row["Цветность"],
                density: row["Плотность"],
                material: row["Материал"],
                quantity: parseInt(row["МинКол-во"]),
                price: parseInt(row["Цена"])
            }));
        });
        createSectionButtons();
    }

    function createSectionButtons() {
        const sectionContainer = document.getElementById('section-buttons');
        sectionContainer.innerHTML = '';
        for (const section in priceData) {
            const button = document.createElement('button');
            button.className = 'option-button';
            button.textContent = section;
            button.onclick = function() {
                selectOption('section', section, this);
                updateOptionButtons('format', [...new Set(priceData[section].map(item => item.format))]);
            };
            sectionContainer.appendChild(button);
        }
    }

    function updateOptionButtons(type, options) {
        const container = document.getElementById(`${type}-buttons`);
        container.innerHTML = '';
        options.forEach(option => {
            const button = document.createElement('button');
            button.className = 'option-button';
            button.textContent = option;
            button.onclick = function() { selectOption(type, option, this); updateNextOptions(type, option); };
            container.appendChild(button);
        });
    }

    function updateNextOptions(type, option) {
        if (type === 'format') updateOptionButtons('color', [...new Set(priceData[currentSection].filter(i => i.format === option).map(i => i.color))]);
        if (type === 'color') updateOptionButtons('density', [...new Set(priceData[currentSection].filter(i => i.format === currentFormat && i.color === option).map(i => i.density))]);
        if (type === 'density') updateOptionButtons('material', [...new Set(priceData[currentSection].filter(i => i.format === currentFormat && i.color === currentColor && i.density === option).map(i => i.material))]);
        updatePriceInfo();
    }

    function selectOption(type, value, element) {
        element.parentElement.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
        element.classList.add('selected');
        if (type === 'section') currentSection = value;
        if (type === 'format') currentFormat = value;
        if (type === 'color') currentColor = value;
        if (type === 'density') currentDensity = value;
        if (type === 'material') currentMaterial = value;
        updatePriceInfo();
    }

    function findAppropriatePrice(section, format, color, density, material, quantity) {
        const matches = priceData[section].filter(i => i.format === format && i.color === color && i.density === density && i.material === material);
        if (matches.length === 0) return null;
        matches.sort((a, b) => a.quantity - b.quantity);
        let result = matches[0];
        for (let i = matches.length - 1; i >= 0; i--) {
            if (quantity >= matches[i].quantity) { result = matches[i]; break; }
        }
        return result;
    }

    function updatePriceInfo() {
        const q = parseInt(document.getElementById('quantity').value) || 1;
        if (!currentSection || !currentFormat || !currentColor || !currentDensity || !currentMaterial) return;
        const item = findAppropriatePrice(currentSection, currentFormat, currentColor, currentDensity, currentMaterial, q);
        if (!item) return;
        document.getElementById('price-details').innerHTML = `Цена за шт: ${item.price} руб.<br>Минимальный заказ: ${item.quantity} шт.<br>Общая стоимость: ${item.price * q} руб.`;
        document.getElementById('price-info').classList.remove('hidden');
    }

    function addToCart() {
        const q = parseInt(document.getElementById('quantity').value) || 1;
        const item = findAppropriatePrice(currentSection, currentFormat, currentColor, currentDensity, currentMaterial, q);
        if (!item) return alert('Не найдено!');
        cart.push({ section: currentSection, format: currentFormat, color: currentColor, density: currentDensity, material: currentMaterial, quantity: q, unitPrice: item.price, minQuantity: item.quantity, price: item.price * q });
        updateCart();
    }

    function updateCart() {
        const cartItems = document.getElementById('cart-items');
        cartItems.innerHTML = '';
        let total = 0;
        cart.forEach((item, i) => { total += item.price; cartItems.innerHTML += `<div><b>${item.section}</b> (${item.format}, ${item.color}, ${item.density}, ${item.material})<br>${item.quantity}×${item.unitPrice}=${item.price} руб.</div>`; });
        document.getElementById('total-price').innerText = total + ' руб.';
    }

    function openTelegram() {
        if (cart.length === 0) return alert('Корзина пуста!');
        let message = "Здравствуйте! Хочу сделать заказ:\n\n";
        cart.forEach((item, i) => {
            message += `${i + 1}. ${item.section} - ${item.format}, ${item.color}, ${item.density}, ${item.material}\n`;
            message += `Количество: ${item.quantity} шт. (мин. ${item.minQuantity} шт.)\n`;
            message += `Цена за шт: ${item.unitPrice} руб.\n`;
            message += `Стоимость: ${item.price} руб.\n\n`;
        });
        message += `Итоговая стоимость: ${cart.reduce((s, i) => s + i.price, 0)} руб.`;
        window.open(`https://t.me/Mobik39_print?text=${encodeURIComponent(message)}`, '_blank');
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    function selectStickerOption(type, value, element) {
        // Сбрасываем выделение всех кнопок в этой группе
        const buttons = element.parentElement.querySelectorAll('.option-button');
        buttons.forEach(btn => btn.classList.remove('selected'));

        // Выделяем выбранную кнопку
        element.classList.add('selected');

        // Сохраняем выбранное значение
        if (type === 'sheet-type') currentSheetType = value;
        if (type === 'item-type') currentItemType = value;

        // Обновляем видимые поля
        toggleStickerFields();
    }

    // Функция переключения полей для наклеек
    function toggleStickerFields() {
        const rectFields = document.getElementById('rect-fields');
        const circleFields = document.getElementById('circle-fields');

        if (currentItemType === 'rect') {
            rectFields.classList.remove('hidden');
            circleFields.classList.add('hidden');
        } else {
            rectFields.classList.add('hidden');
            circleFields.classList.remove('hidden');
        }
    }

    // Функция расчета наклеек
    function calculateStickers() {
        let sheetWidth, sheetHeight;

        if (currentSheetType === 'SRA3') {
            sheetWidth = 285;
            sheetHeight = 385;
        } else {
            sheetWidth = 210;
            sheetHeight = 285;
        }

        let itemsPerSheet = 0;

        if (currentItemType === 'rect') {
            const length = parseFloat(document.getElementById('length').value) || 0;
            const width = parseFloat(document.getElementById('width').value) || 0;

            if (length <= 0 || width <= 0) {
                alert('Пожалуйста, введите корректные значения длины и ширины!');
                return;
            }

            // Расчет количества на листе (ориентация по горизонтали и вертикали)
            const horizontal = Math.floor(sheetWidth / width) * Math.floor(sheetHeight / length);
            const vertical = Math.floor(sheetWidth / length) * Math.floor(sheetHeight / width);

            itemsPerSheet = Math.max(horizontal, vertical);
        } else {
            const diameter = parseFloat(document.getElementById('diameter').value) || 0;

            if (diameter <= 0) {
                alert('Пожалуйста, введите корректное значение диаметра!');
                return;
            }

            // Простая приближённая укладка кругов в сетку
            const rows = Math.floor(sheetHeight / diameter);
            const cols = Math.floor(sheetWidth / diameter);

            itemsPerSheet = rows * cols;
        }

        document.getElementById('total-items').textContent = itemsPerSheet;
    }

    // Инициализация при загрузке страницы
    window.onload = function() {
        loadPriceData().catch(err => {
            console.error(err);
            alert('Ошибка при загрузке data.xlsx. Убедитесь, что файл data.xlsx находится в той же папке и доступен.');
        });

        // Обновляем корзину и поля наклеек
        updateCart();
        toggleStickerFields();
    };

</script>
</body>
</html>
